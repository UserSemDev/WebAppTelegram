{% extends "base.html" %}

{% block title %}Web App Telegram{% endblock %}

{% block extra_styles %}
<style>
    body {
        background-color: #fffafa;  /* Black background for the entire page */
        color: purple;  /* Purple text color */
    }
    .user-info-card {
        margin: 20px auto;
        font-size: 14px;
        color: purple;
        background-color: #1c1c1c;  /* Dark background for the card */
    }
    .card-header {
        background-color: #2c2c2c;  /* Dark background for the card header */
        color: #fffafa;
    }
    .card-body {
        color: #f0fff0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card user-info-card">
                <div class="card-header text-center">
                    User Information
                </div>
                <div class="card-body">
                    <p class="card-text"><strong>User ID:</strong> <span id="user-id">unknown</span></p>
                    <p class="card-text"><strong>First Name:</strong> <span id="first-name">unknown</span></p>
                    <p class="card-text"><strong>Last Name:</strong> <span id="last-name">unknown</span></p>
                    <p class="card-text"><strong>Username:</strong> <span id="username">unknown</span></p>
                    <p class="card-text"><strong>Is Premium:</strong> <span id="is-premium">unknown</span></p>
                    <a href="{% url 'admin:index' %}">Админка</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://telegram.org/js/telegram-web-app.js"></script> <!-- Connection of the SDK -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const telegram = window.Telegram.WebApp;

        // Проверяем, если initDataUnsafe доступен
        if (telegram && telegram.initDataUnsafe && telegram.initDataUnsafe.user) {
            const user = telegram.initDataUnsafe.user;

            // Заполняем данные пользователя
            const telegramId = user.id || 'unknown';
            const firstName = user.first_name || 'unknown';
            const lastName = user.last_name || 'unknown';
            const username = user.username || 'unknown';
            const isPremium = user.is_premium ? 'Yes' : 'No';

            // Обновляем элементы на странице
            document.getElementById('user-id').textContent = telegramId;
            document.getElementById('first-name').textContent = firstName;
            document.getElementById('last-name').textContent = lastName;
            document.getElementById('username').textContent = username;
            document.getElementById('is-premium').textContent = isPremium;
        } else {
            // Если данные не получены
            document.getElementById('user-id').textContent = 'unknown';
            document.getElementById('first-name').textContent = 'unknown';
            document.getElementById('last-name').textContent = 'unknown';
            document.getElementById('username').textContent = 'unknown';
            document.getElementById('is-premium').textContent = 'unknown';
        }

        // Дополнительно: Отправляем данные на сервер
        const data = {
            telegram_id: telegram.initDataUnsafe?.user?.id || null,
            first_name: telegram.initDataUnsafe?.user?.first_name || '',
            last_name: telegram.initDataUnsafe?.user?.last_name || '',
            username: telegram.initDataUnsafe?.user?.username || '',
            is_premium: telegram.initDataUnsafe?.user?.is_premium || false,
            user_data: telegram.initDataUnsafe || {},
            init_data: telegram.initData || {},
        };

        // Отправка данных на сервер
        fetch("/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "ngrok-skip-browser-warning": "true"
            },
            body: JSON.stringify(data),
        })
        .then(response => response.json())
        .then(responseData => {
            console.log("Ответ от сервера:", responseData);
        })
        .catch(error => {
            console.error("Ошибка отправки данных:", error);
        });
    });
</script>
{% endblock %}